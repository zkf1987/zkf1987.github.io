<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="自动化运维,nginx,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta name="description" content="描述nginx服务器日志相关指令主要有两条：一条是log_format，用来设置日志格式；另外一条是access_log，用来指定日志文件的存放路径、格式和缓存大小，可以参加ngx_http_log_module。一般在nginx的配置文件中日记配置(/usr/local/nginx/conf/nginx.conf)。">
<meta name="keywords" content="自动化运维,nginx">
<meta property="og:type" content="article">
<meta property="og:title" content="nginx内置变量以及日志格式变量参数详解">
<meta property="og:url" content="http://yoursite.com/2019/03/25/blog/nginx内置变量以及日志格式变量参数详解/index.html">
<meta property="og:site_name" content="这家伙真懒">
<meta property="og:description" content="描述nginx服务器日志相关指令主要有两条：一条是log_format，用来设置日志格式；另外一条是access_log，用来指定日志文件的存放路径、格式和缓存大小，可以参加ngx_http_log_module。一般在nginx的配置文件中日记配置(/usr/local/nginx/conf/nginx.conf)。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-03-25T03:55:00.285Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="nginx内置变量以及日志格式变量参数详解">
<meta name="twitter:description" content="描述nginx服务器日志相关指令主要有两条：一条是log_format，用来设置日志格式；另外一条是access_log，用来指定日志文件的存放路径、格式和缓存大小，可以参加ngx_http_log_module。一般在nginx的配置文件中日记配置(/usr/local/nginx/conf/nginx.conf)。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/03/25/blog/nginx内置变量以及日志格式变量参数详解/">





  <title> nginx内置变量以及日志格式变量参数详解 | 这家伙真懒 </title>
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">这家伙真懒</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">mooon</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-xinyang">
          <a href="/xinyang" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            告白
          </a>
        </li>
      
        
        <li class="menu-item menu-item-book">
          <a href="/book" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-address-book"></i> <br>
            
            menu.book
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input">
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'bRi9SMH65fh2yRbuHHKj','2.0.0');
</script>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/25/blog/nginx内置变量以及日志格式变量参数详解/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="这家伙真懒">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ooj9cf5vc.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20170417164723.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="这家伙真懒">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                nginx内置变量以及日志格式变量参数详解
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-25T10:37:13+08:00">
                2019-03-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/技术文章/" itemprop="url" rel="index">
                    <span itemprop="name">技术文章</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/03/25/blog/nginx内置变量以及日志格式变量参数详解/" class="leancloud_visitors" data-flag-title="nginx内置变量以及日志格式变量参数详解">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h2><p>nginx服务器日志相关指令主要有两条：一条是log_format，用来设置日志格式；另外一条是access_log，用来指定日志文件的存放路径、格式和缓存大小，可以参加ngx_http_log_module。一般在nginx的配置文件中日记配置(/usr/local/nginx/conf/nginx.conf)。<br><a id="more"></a></p>
<h2 id="参数详解"><a href="#参数详解" class="headerlink" title="参数详解"></a>参数详解</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span>args                    #请求中的参数值</span><br><span class="line"><span class="meta">$</span>query_string            #同 $args</span><br><span class="line"><span class="meta">$</span>arg_NAME                #GET请求中NAME的值</span><br><span class="line"><span class="meta">$</span>is_args                 #如果请求中有参数，值为"?"，否则为空字符串</span><br><span class="line"><span class="meta">$</span>uri                     #请求中的当前URI(不带请求参数，参数位于$args)，可以不同于浏览器传递的$request_uri的值，它可以通过内部重定向，或者使用index指令进行修改，$uri不包含主机名，如"/foo/bar.html"。</span><br><span class="line"><span class="meta">$</span>document_uri            #同 $uri</span><br><span class="line"><span class="meta">$</span>document_root           #当前请求的文档根目录或别名</span><br><span class="line"><span class="meta">$</span>host                    #优先级：HTTP请求行的主机名&gt;"HOST"请求头字段&gt;符合请求的服务器名.请求中的主机头字段，如果请求中的主机头不可用，则为服务器处理请求的服务器名称</span><br><span class="line"><span class="meta">$</span>hostname                #主机名</span><br><span class="line"><span class="meta">$</span>https                   #如果开启了SSL安全模式，值为"on"，否则为空字符串。</span><br><span class="line"><span class="meta">$</span>binary_remote_addr      #客户端地址的二进制形式，固定长度为4个字节</span><br><span class="line"><span class="meta">$</span>body_bytes_sent         #传输给客户端的字节数，响应头不计算在内；这个变量和Apache的mod_log_config模块中的"%B"参数保持兼容</span><br><span class="line"><span class="meta">$</span>bytes_sent              #传输给客户端的字节数</span><br><span class="line"><span class="meta">$</span>connection              #TCP连接的序列号</span><br><span class="line"><span class="meta">$</span>connection_requests     #TCP连接当前的请求数量</span><br><span class="line"><span class="meta">$</span>content_length          #"Content-Length" 请求头字段</span><br><span class="line"><span class="meta">$</span>content_type            #"Content-Type" 请求头字段</span><br><span class="line"><span class="meta">$</span>cookie_name             #cookie名称</span><br><span class="line"><span class="meta">$</span>limit_rate              #用于设置响应的速度限制</span><br><span class="line"><span class="meta">$</span>msec                    #当前的Unix时间戳</span><br><span class="line"><span class="meta">$</span>nginx_version           #nginx版本</span><br><span class="line"><span class="meta">$</span>pid                     #工作进程的PID</span><br><span class="line"><span class="meta">$</span>pipe                    #如果请求来自管道通信，值为"p"，否则为"."</span><br><span class="line"><span class="meta">$</span>proxy_protocol_addr     #获取代理访问服务器的客户端地址，如果是直接访问，该值为空字符串</span><br><span class="line"><span class="meta">$</span>realpath_root           #当前请求的文档根目录或别名的真实路径，会将所有符号连接转换为真实路径</span><br><span class="line"><span class="meta">$</span>remote_addr             #客户端地址</span><br><span class="line"><span class="meta">$</span>remote_port             #客户端端口</span><br><span class="line"><span class="meta">$</span>remote_user             #用于HTTP基础认证服务的用户名</span><br><span class="line"><span class="meta">$</span>request                 #代表客户端的请求地址</span><br><span class="line"><span class="meta">$</span>request_body            #客户端的请求主体：此变量可在location中使用，将请求主体通过proxy_pass，fastcgi_pass，uwsgi_pass和scgi_pass传递给下一级的代理服务器</span><br><span class="line"><span class="meta">$</span>request_body_file       #将客户端请求主体保存在临时文件中。文件处理结束后，此文件需删除。如果需要之一开启此功能，需要设置client_body_in_file_only。如果将次文件传 递给后端的代理服务器，需要禁用request body，即设置proxy_pass_request_body off，fastcgi_pass_request_body off，uwsgi_pass_request_body off，or scgi_pass_request_body off</span><br><span class="line"><span class="meta">$</span>request_completion      #如果请求成功，值为"OK"，如果请求未完成或者请求不是一个范围请求的最后一部分，则为空</span><br><span class="line"><span class="meta">$</span>request_filename        #当前连接请求的文件路径，由root或alias指令与URI请求生成</span><br><span class="line"><span class="meta">$</span>request_length          #请求的长度 (包括请求的地址，http请求头和请求主体)</span><br><span class="line"><span class="meta">$</span>request_method          #HTTP请求方法，通常为"GET"或"POST"</span><br><span class="line"><span class="meta">$</span>request_time            #处理客户端请求使用的时间,单位为秒，精度毫秒； 从读入客户端的第一个字节开始，直到把最后一个字符发送给客户端后进行日志写入为止。</span><br><span class="line"><span class="meta">$</span>request_uri             #这个变量等于包含一些客户端请求参数的原始URI，它无法修改，请查看$uri更改或重写URI，不包含主机名，例如："/cnphp/test.php?arg=freemouse"</span><br><span class="line"><span class="meta">$</span>scheme                  #请求使用的Web协议，"http" 或 "https"</span><br><span class="line"><span class="meta">$</span>server_addr             #服务器端地址，需要注意的是：为了避免访问linux系统内核，应将ip地址提前设置在配置文件中</span><br><span class="line"><span class="meta">$</span>server_name             #服务器名</span><br><span class="line"><span class="meta">$</span>server_port             #服务器端口</span><br><span class="line"><span class="meta">$</span>server_protocol         #服务器的HTTP版本，通常为 "HTTP/1.0" 或 "HTTP/1.1"</span><br><span class="line"><span class="meta">$</span>status                  #HTTP响应代码</span><br><span class="line"><span class="meta">$</span>time_iso8601            #服务器时间的ISO 8610格式</span><br><span class="line"><span class="meta">$</span>time_local              #服务器时间（LOG Format 格式）</span><br><span class="line"><span class="meta">$</span>cookie_NAME             #客户端请求Header头中的cookie变量，前缀"$cookie_"加上cookie名称的变量，该变量的值即为cookie名称的值</span><br><span class="line"><span class="meta">$</span>http_NAME               #匹配任意请求头字段；变量名中的后半部分NAME可以替换成任意请求头字段，如在配置文件中需要获取http请求头："Accept-Language"，$http_accept_language即可</span><br><span class="line"><span class="meta">$</span>http_cookie</span><br><span class="line"><span class="meta">$</span>http_host               #请求地址，即浏览器中你输入的地址（IP或域名）</span><br><span class="line"><span class="meta">$</span>http_referer            #url跳转来源,用来记录从那个页面链接访问过来的</span><br><span class="line"><span class="meta">$</span>http_user_agent         #用户终端浏览器等信息</span><br><span class="line"><span class="meta">$</span>http_x_forwarded_for</span><br><span class="line"><span class="meta">$</span>sent_http_NAME          #可以设置任意http响应头字段；变量名中的后半部分NAME可以替换成任意响应头字段，如需要设置响应头Content-length，$sent_http_content_length即可</span><br><span class="line"><span class="meta">$</span>sent_http_cache_control</span><br><span class="line"><span class="meta">$</span>sent_http_connection</span><br><span class="line"><span class="meta">$</span>sent_http_content_type</span><br><span class="line"><span class="meta">$</span>sent_http_keep_alive</span><br><span class="line"><span class="meta">$</span>sent_http_last_modified</span><br><span class="line"><span class="meta">$</span>sent_http_location</span><br><span class="line"><span class="meta">$</span>sent_http_transfer_encoding</span><br></pre></td></tr></table></figure>
<p>我现在使用的日志格式：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">log_format log_stream '$time_local || $remote_addr || $upstream_addr || $status || $protocol || $bytes_sent || $bytes_received || $session_time || $upstream_bytes_sent || $upstream_bytes_received || $upstream_connect_time';</span><br><span class="line"></span><br><span class="line">log_format upstreaminfo </span><br><span class="line">'$time_local            请求时间</span><br><span class="line"><span class="meta">$</span>remote_addr         客户端地址</span><br><span class="line"><span class="meta">$</span>upstream_addr      后台upstream的地址，即真正提供服务的主机地址</span><br><span class="line"><span class="meta">$</span>status                     HTTP请求状态</span><br><span class="line"><span class="meta">$</span>request_time          整个请求的总时间</span><br><span class="line"><span class="meta">$</span>upstream_status      upstream的状态</span><br><span class="line"><span class="meta">$</span>upstream_response_time           请求过程中，upstream响应时间</span><br><span class="line"><span class="meta">$</span>upstream_cache_status               </span><br><span class="line"><span class="meta">$</span>body_bytes_sent                        发送客户端文件内容大小</span><br><span class="line"><span class="meta">$</span>http_referer                                 URL跳转来源</span><br><span class="line"><span class="meta">$</span>remote_user                                用于HTTP基础认证服务的用户名    </span><br><span class="line"><span class="meta">$</span>http_user_agent                           用户终端浏览器等信息</span><br><span class="line"><span class="meta">$</span>http_x_forwarded_for                  是客户端真实的IP地址</span><br><span class="line"><span class="meta">$</span>request                                         请求的URL和HTTP协议</span><br><span class="line"><span class="meta">$</span>http_host                                      请求地址即浏览器中你输入的地址（IP或域名）</span><br><span class="line"><span class="meta">$</span>cookie_cmos_vision';</span><br></pre></td></tr></table></figure></p>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">log_format指令用来设置日志的记录格式，它的语法如下：</span><br><span class="line">log_format name format &#123;format ...&#125;</span><br><span class="line">其中name表示定义的格式名称，format表示定义的格式样式。</span><br><span class="line"> </span><br><span class="line">log_format有一个默认的、无须设置的combined日志格式设置，相当于Apache的combined日志格式，其具体参数如下：</span><br><span class="line">log_format combined '$remote_addr-$remote_user [$time_local]'</span><br><span class="line">‘"$request"$status $body_bytes_sent’</span><br><span class="line"> ‘"$http_referer" "$http_user_agent"’</span><br><span class="line"> </span><br><span class="line">也可以自定义一份日志的记录格式，不过要注意，log_format指令设置的名称在配置文件中是不能重复的。</span><br><span class="line"> </span><br><span class="line">假设将Nginx服务器作为Web服务器，位于负载均衡设备、Squid、Nginx反向代理之后，不能获取到客户端的真实IP地址了。</span><br><span class="line">原因是经过反向代理后，由于在客户端和Web服务器之间增加了中间层，因此Web服务器无法直接拿到客户端的IP。</span><br><span class="line">通过$remote_addr变量拿到的将是反向代理服务器的IP地址。</span><br><span class="line"> </span><br><span class="line">但是，反向代理服务器在转发请求的HTTP头信息中，可以增加X-Forwarded-For信息，用以记录原有的客户端IP地址和原来客户端请求的服务器地址。</span><br><span class="line">这时候，要用log_format指令设置日志格式，让日志记录X-Forearded-For信息中的IP地址，即客户的真实IP。</span><br><span class="line"> </span><br><span class="line">例如，创建一个名为mylogformat的日志格式，再$http_x_forwarded_forlog_for变量记录用户的X_Forwarded-For IP 地址：</span><br><span class="line">log_format mylogformat '$http_x_forwarded_for_$remote_user [$time_local]'</span><br><span class="line">‘"$request"$status $body_bytes_sent’</span><br><span class="line"> ‘"$http_referer" "$http_user_agent"’</span><br><span class="line">在日志格式样式中，变量$remote_addr和$http_x_forwarded_for用于记录IP地址；</span><br><span class="line"><span class="meta">$</span>remote_user用于记录远程客户端用户名称；</span><br><span class="line"><span class="meta">$</span>time_local用于记录访问时间与时区；</span><br><span class="line"><span class="meta">$</span>request用于记录请求URL与HTTP协议；</span><br><span class="line"><span class="meta">$</span>status用于记录请求状态，例如成功时状态为200，页面找不到时状态为404；</span><br><span class="line"><span class="meta">$</span>body_bytes_sent用于记录发送客户端的文件主体内容大小；</span><br><span class="line"><span class="meta">$</span>http_referer用于记录是从哪个页面链接访问过来的；</span><br><span class="line"><span class="meta">$</span>http_user_agent用于记录客户浏览器的相关信息。</span><br></pre></td></tr></table></figure>
<blockquote>
<p>一般来说：nginx的log_format有很多可选的参数用于指示服务器的活动状态，默认的是：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span><br><span class="line">                  '$status $body_bytes_sent "$http_referer" '</span><br><span class="line">                  '"$http_user_agent" "$http_x_forwarded_for"';</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>想要记录更详细的信息需要自定义设置log_format，具体可设置的参数格式及说明如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">参数                      说明                                         示例</span><br><span class="line"><span class="meta">$</span>remote_addr             客户端地址                                    211.28.65.253</span><br><span class="line"><span class="meta">$</span>remote_user             客户端用户名称                                --</span><br><span class="line"><span class="meta">$</span>time_local              访问时间和时区                                18/Jul/2012:17:00:01 +0800</span><br><span class="line"><span class="meta">$</span>request                 请求的URI和HTTP协议                           "GET /article-10000.html HTTP/1.1"</span><br><span class="line"><span class="meta">$</span>http_host               请求地址，即浏览器中你输入的地址（IP或域名）     www.wang.com 192.168.100.100</span><br><span class="line"><span class="meta">$</span>status                  HTTP请求状态                                  200</span><br><span class="line"><span class="meta">$</span>upstream_status         upstream状态                                  200</span><br><span class="line"><span class="meta">$</span>body_bytes_sent         发送给客户端文件内容大小                        1547</span><br><span class="line"><span class="meta">$</span>http_referer            url跳转来源                                   https://www.baidu.com/</span><br><span class="line"><span class="meta">$</span>http_user_agent         用户终端浏览器等信息                           "Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; SV1; GTB7.0; .NET4.0C;</span><br><span class="line"><span class="meta">$</span>ssl_protocol            SSL协议版本                                   TLSv1</span><br><span class="line"><span class="meta">$</span>ssl_cipher              交换数据中的算法                               RC4-SHA</span><br><span class="line"><span class="meta">$</span>upstream_addr           后台upstream的地址，即真正提供服务的主机地址     10.10.10.100:80</span><br><span class="line"><span class="meta">$</span>request_time            整个请求的总时间                               0.205</span><br><span class="line"><span class="meta">$</span>upstream_response_time  请求过程中，upstream响应时间                    0.002</span><br></pre></td></tr></table></figure>
<p>如下是在nginx的LB代理层使用过的一个配置（nginx.conf中配置）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">log_format  main  '$remote_addr $remote_user [$time_local] "$request" '</span><br><span class="line">                  '$status $body_bytes_sent "$http_referer" '</span><br><span class="line">                  '$http_user_agent $http_x_forwarded_for $request_time $upstream_response_time $upstream_addr $upstream_status';</span><br></pre></td></tr></table></figure>
<p>然后在nginx.conf文件或vhosts/*.conf文件中的access_log日志中指定级别为main。如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">access_log  logs/wiki_access.log main;</span><br><span class="line">error_log   logs/wiki_error.log;</span><br></pre></td></tr></table></figure>
<h2 id="nginx-reload"><a href="#nginx-reload" class="headerlink" title="nginx reload"></a>nginx reload</h2><p>nginx -s  reload 命令加载修改后的配置文件,命令下达后发生如下事件</p>
<ol>
<li><p>Nginx的master进程检查配置文件的正确性，若是错误则返回错误信息，nginx继续采用原配置文件进行工作（因为worker未受到影响）</p>
</li>
<li><p>Nginx启动新的worker进程，采用新的配置文件</p>
</li>
<li><p>Nginx将新的请求分配新的worker进程</p>
</li>
<li><p>Nginx等待以前的worker进程的全部请求已经都返回后，关闭相关worker进程</p>
</li>
<li><p>重复上面过程，知道全部旧的worker进程都被关闭掉</p>
<p>首先是nginx执行这样一个命令其nginx的内部是如何做的呢?</p>
<p>其整个过程是这样的——首先会新起一个nginxmaster进程、然后进行配置的预校验、如果配置上是没有语法错误（像端口冲突啥的是无法检测的）就会给之前的master进程发送信号、然后老的master进行配置解析、fork出新的worker进程（待新起来的进程准备工作就绪、此时master进程就会通知老的worker进程关闭相关监听套接字，即不在介绍新的请求、待老的worker上的各种事件处理完成后就退出）</p>
</li>
</ol>
<blockquote>
<p>.注意其实在执行nginx -s reload会有这样几个问题:</p>
</blockquote>
<p>1.若有大量请求,此时会丢请求.<br>原因是:在某一时刻nginx的worker进程是之前的二倍,导致系统资源的下降[并发自然也下降了qps]而且多个worker之间进 行锁的竞争。</p>
<p>2.若此时worker子进程比较多则会很耗费内存。<br>由于老的worker子进程要把当前的请求的任务处理完成才会释放worker进程的资源,所以若果老的worker和后端的机器 keepalive什么的话则在一段时间内nginx的worker进程个数会随着reload的次数成倍数增加。</p>
<p>Once the master process receives the signal to reload configuration, it checks the syntax validity of the new configuration file and tries to apply the configuration provided in it. If this is a success, the master process starts new worker processes and sends messages to old worker processes, requesting them to shut down. Otherwise, the master process rolls back the changes and continues to work with the old configuration. Old worker processes, receiving a command to shut down, stop accepting new connections and continue to service current requests until all such requests are serviced. After that, the old worker processes exit.</p>
<p>一旦主进程收到重新加载配置的信号，它将检查新配置文件的语法有效性并尝试应用其中提供的配置。如果成功，主进程将启动新的工作进程并向旧工作进程发送消息，请求它们关闭。否则，主进程将回滚更改并继续使用旧配置。旧工作进程，接收命令以关闭，停止接受新连接并继续为当前请求提供服务，直到所有此类请求都得到服务。之后，旧工作进程退出。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/log-format/" target="_blank" rel="noopener">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/log-format/</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/自动化运维/" rel="tag"># 自动化运维</a>
          
            <a href="/tags/nginx/" rel="tag"># nginx</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/03/12/blog/k8s-service资源理解/" rel="next" title="k8s-service资源理解">
                <i class="fa fa-chevron-left"></i> k8s-service资源理解
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/03/27/blog/k8s集群master节点Reset后恢复操作说明/" rel="prev" title="k8s集群master节点Reset后恢复操作说明">
                k8s集群master节点Reset后恢复操作说明 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="http://ooj9cf5vc.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20170417164723.jpg" alt="这家伙真懒">
          <p class="site-author-name" itemprop="name">这家伙真懒</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">88</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">64</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#描述"><span class="nav-number">1.</span> <span class="nav-text">描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参数详解"><span class="nav-number">2.</span> <span class="nav-text">参数详解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#例子"><span class="nav-number">3.</span> <span class="nav-text">例子</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx-reload"><span class="nav-number">4.</span> <span class="nav-text">nginx reload</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">5.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">这家伙真懒</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  





  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("zsiNfRfGxHuzfd3jhKcQpFPd-gzGzoHsz", "TGYb1Fm9SJyIApoiuROTP72s");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

</body>
</html>
